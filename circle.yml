machine:
  environment:
    BUILDTIME: $(TZ=GMT date "+%Y-%m-%d_%H:%M_GMT")
    DOCKER_API_VERSION: 1.21
  pre:
    # install docker
    - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.1-circleci'
    - sudo chmod +x /usr/bin/docker
    # install dobi
    - sudo curl -L -o /usr/bin/dobi 'https://github.com/dnephin/dobi/releases/download/v0.8/dobi-linux'
    - sudo chmod +x /usr/bin/dobi
  services:
    - docker
dependencies:
  cache_directories:
    - .glide
  override:
    # create builder image
    - dobi builder
    # compile Pumba binary (linux/amd64)
    - dobi compile
    # create Pumba Docker image too
    - BUILD=${CIRCLE_BUILD_NUM} dobi dist-img
test:
  override:
    # run tests for all Pumba packages (exl. vendor), calculate coverage and generate junit.xml reports
    - dobi unit-test
    # run bats integration tests and produce TAP report
    - dobi integration-test
  post:
    # copy test results
    - cp .cover/*_tests.xml ${CIRCLE_TEST_REPORTS}
    # copy integration test results
    - cp tests.output ${CIRCLE_TEST_REPORTS}
    # push coverage data to codecov
    - bash <(curl -s https://codecov.io/bash)
deployment:
  continuous:
    branch: [master, develop, /feature_.*/]
    commands:
      # tag image with CircleCi branch and build
      - dobi dist-img:tag
      # deply image to DockerHub
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - dobi dist-img:push
  github-release:
    tag: /[0-9]+(\.[0-9]+)*/
    commands:
      # cross compile Pumba for multiple platforms
      - dobi cross-compile
      # publish new release to GitHub
      - RELEASE_TAG=$(git describe --tags); TAG_MESSAGE=$(local rel=`git describe --tags` && git tag -l $rel -n 20 | awk '{$1=""; print}'); dobi github-release
notify:
  webhooks:
    - url: https://hooks.microbadger.com/images/gaiaadm/pumba/mFsG9N5E0frOdrOLTPjYKqqt-Iw=
general:
  artifacts:
    - dist/bin
