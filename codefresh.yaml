version: '1.0'

steps:

  main_build:
    type: build
    title: Multi-stage Build - compile, test, coverage
    description: compile for linux amd64, runt unit test, calculate coverage 
    working-directory: ${{main_clone}}
    image_name: gaiaadm/pumba
    build_arguments:
      - GH_SHA=${{CF_REVISION}}
      - GITHUB_TOKEN=${{GITHUB_TOKEN}}
      - CODECOV_TOKEN=${{CODECOV_TOKEN}}

  gox_build:
    type: build
    title: Build and Release to the GitHub
    description: cross-platform compile, run unit tests, report coverage and release to the GitHub
    working-directory: ${{main_clone}}
    image_name: gaiaadm/pumba
    build_arguments:
      - RELEASE=true
      - GH_SHA=${{CF_REVISION}}
      - GITHUB_TOKEN=${{GITHUB_TOKEN}}
      - CODECOV_TOKEN=${{CODECOV_TOKEN}}
    when:
      branch:
        only:
          - master

  push_branch:
    type: push
    title: Push Pumba (branch)
    description: Push Pumba image to DockerHub
    candidate: ${{main_build}}
    tag: ${{CF_BRANCH}}
    image_name: gaiaadm/pumba

  push_revision:
    type: push
    title: Push Pumba (branch-revision)
    description: Push Pumba image to the DockerHub
    candidate: ${{main_build}}
    tag: ${{CF_SHORT_REVISION}}
    image_name: gaiaadm/pumba

  push_latest:
    type: push
    title: Push Pumba (latest)
    description: Push Pumba image to the DockerHub
    candidate: ${{main_build}}
    tag: latest
    image_name: gaiaadm/pumba
    when:
      branch:
        only:
          - master