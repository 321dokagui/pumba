version: '1.0'

steps:

  main-build:
    type: build
    title: Build Pumba
    description: create Pumba with multi-stage build
    working-directory: ${{main_clone}}
    image-name: gaiaadm/pumba
    build_arguments:
      - GH_SHA=${{CF_REVISION}}
      - GITHUB_TOKEN=${{GITHUB_TOKEN}}
      - CODECOV_TOKEN=${{CODECOV_TOKEN}}

  gox-build:
    type: build
    title: Release Pumba
    description: Release Pumba to to the GitHub
    working-directory: ${{main_clone}}
    image-name: gaiaadm/pumba
    build_arguments:
      - RELEASE=true
      - GH_SHA=${{CF_REVISION}}
      - GITHUB_TOKEN=${{GITHUB_TOKEN}}
      - CODECOV_TOKEN=${{CODECOV_TOKEN}}
    when:
      branch:
        only:
          - master

  push-branch:
    type: push
    title: Push Pumba (branch)
    description: Push Pumba image to DockerHub
    candidate: ${{main-build}}
    tag: ${{CF_BRANCH}}
    image_name: gaiaadm/pumba

  push-revision:
    type: push
    title: Push Pumba (branch-rev)
    description: Push Pumba image to DockerHub
    candidate: ${{main-build}}
    tag: ${{CF_SHORT_REVISION}}
    image_name: gaiaadm/pumba

  push-latest:
    type: push
    title: Push Pumba (latest)
    description: Push Pumba image to DockerHub
    candidate: ${{main-build}}
    tag: latest
    image_name: gaiaadm/pumba
    when:
      branch:
        only:
          - master